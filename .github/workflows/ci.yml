name: CI

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore tools
        run: dotnet tool restore

      - name: Restore dependencies
        run: dotnet restore
  
      - name: Lint (dotnet format)
        run: dotnet format --verify-no-changes

  tests:
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - uses: actions/checkout@v4
  
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
  
      - name: Restore
        run: dotnet restore

      - name: Vulnerability scan (NuGet)
        run: dotnet list package --vulnerable --include-transitive

      - name: Run unit tests with coverage
        run: |
          dotnet test tests/MyApi.UnitTests \
          --collect:"XPlat Code Coverage" \
          --results-directory TestResults/Unit

      - name: Run integration tests with coverage
        run: |
          dotnet test tests/MyApi.IntegrationTests \
          --collect:"XPlat Code Coverage" \
          --results-directory TestResults/Integration

      - name: Install ReportGenerator
        run: |
          dotnet tool install --global dotnet-reportgenerator-globaltool --version 5.*

      - name: Update ReportGenerator
        run: dotnet tool update --global dotnet-reportgenerator-globaltool

      - name: Unit test coverage report
        run: |
          reportgenerator \
            "-reports:TestResults/Unit/**/coverage.cobertura.xml" \
            "-targetdir:coverage-unit" \
            "-reporttypes:HtmlInline_AzurePipelines;Cobertura" \
            "-assemblyfilters:+MyApi*" \
            "-classfilters:+MyApi*;-MyApi.Api.Program;-MyApi.Api.Migrations*" \
            "-linecoverage:80"

      - name: Integration test coverage report
        run: |
          reportgenerator \
            "-reports:TestResults/Integration/**/coverage.cobertura.xml" \
            "-targetdir:coverage-integration" \
            "-reporttypes:HtmlInline_AzurePipelines"
 
      - name: Upload unit coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-unit
          path: coverage-unit

      - name: Upload integration coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-integration
          path: coverage-integration
